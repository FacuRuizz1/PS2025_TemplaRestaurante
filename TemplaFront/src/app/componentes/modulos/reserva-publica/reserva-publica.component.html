<div class="container-fluid reserva-publica-container bg-templa-beige min-vh-100 py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10">
      <!-- Header -->
      <div class="text-center mb-5">
        <h1 class="display-4 text-templa-brown mb-3">
          <i class="bi bi-calendar-check me-3"></i>
          Reservá tu Mesa
        </h1>
        <p class="lead text-muted">Completá los siguientes pasos para hacer tu reserva</p>
      </div>

      <!-- Indicador de pasos -->
      <div class="step-indicator mb-5">
        <div class="step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
          <span class="step-number">1</span>
          <span class="step-title">Comensales</span>
        </div>
        <div class="step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
          <span class="step-number">2</span>
          <span class="step-title">Fecha</span>
        </div>
        <div class="step" [class.active]="currentStep >= 3" [class.completed]="currentStep > 3">
          <span class="step-number">3</span>
          <span class="step-title">Evento</span>
        </div>
        <div class="step" [class.active]="currentStep >= 4" [class.completed]="currentStep > 4">
          <span class="step-number">4</span>
          <span class="step-title">Horario</span>
        </div>
        <div class="step" [class.active]="currentStep >= 5" [class.completed]="currentStep > 5">
          <span class="step-number">5</span>
          <span class="step-title">Tus Datos</span>
        </div>
      </div>

      <!-- Contenido de los pasos -->
      <div class="card shadow-lg border-templa-gold">
        <div class="card-body p-5">
          
          <!-- Paso 1: Cantidad de Comensales -->
          <div *ngIf="currentStep === 1" class="step-content">
            <h3 class="text-center mb-4 text-templa-brown">¿Para cuántas personas?</h3>
            <form [formGroup]="comensalesForm" class="comensales-form">
              <div class="form-group">
                <div class="number-input-container">
                  <button type="button" class="btn-number" 
                          (click)="decrementarComensales()">
                    -
                  </button>
                  <input type="number" 
                         id="cantidadComensales" 
                         formControlName="cantidadComensales" 
                         class="form-control number-input"
                         min="1" 
                         max="20">
                  <button type="button" class="btn-number" 
                          (click)="incrementarComensales()">
                    +
                  </button>
                </div>
                <div *ngIf="comensalesForm.get('cantidadComensales')?.invalid && comensalesForm.get('cantidadComensales')?.touched" 
                     class="error-message">
                  La cantidad debe ser entre 1 y 20 personas
                </div>
              </div>
            </form>
          </div>

          <!-- Paso 2: Fecha con Calendario -->
          <div *ngIf="currentStep === 2" class="step-content">
            <h3 class="text-center mb-4 text-templa-brown">¿Qué día querés reservar?</h3>
            <div class="calendar-container">
              <div class="calendar-header">
                <button type="button" class="nav-btn" (click)="mesAnterior()">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <h3 class="month-year">{{ meses[mesActual.getMonth()] }} {{ mesActual.getFullYear() }}</h3>
                <button type="button" class="nav-btn" (click)="mesSiguiente()">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
              
              <div class="calendar-grid">
                <div class="day-header" *ngFor="let dia of diasSemana">{{ dia }}</div>
                <div 
                  *ngFor="let dia of diasCalendario" 
                  class="calendar-day"
                  [class.other-month]="!dia.esDelMesActual"
                  [class.today]="dia.esHoy"
                  [class.available]="dia.tieneDisponibilidad && dia.esDelMesActual && !dia.esPasado"
                  [class.selected]="esFechaSeleccionada(dia)"
                  [class.past]="dia.esPasado"
                  (click)="seleccionarFecha(dia)">
                  {{ dia.dia }}
                </div>
              </div>
              
              <div class="calendar-legend">
                <div class="legend-item">
                  <div class="legend-color today"></div>
                  <span>Hoy</span>
                </div>
                <div class="legend-item">
                  <div class="legend-color available"></div>
                  <span>Disponible</span>
                </div>
                <div class="legend-item">
                  <div class="legend-color selected"></div>
                  <span>Seleccionado</span>
                </div>
                <div class="legend-item">
                  <div class="legend-color past"></div>
                  <span>No disponible</span>
                </div>
              </div>
              
              <div *ngIf="reservaData.fechaReserva" class="selected-date">
                <i class="fas fa-calendar-check"></i>
                Fecha seleccionada: {{ reservaData.fechaReserva | date:'dd/MM/yyyy' }}
              </div>
            </div>
          </div>

          <!-- Paso 3: Tipo de Evento -->
          <div *ngIf="currentStep === 3" class="step-content">
            <h3 class="text-center mb-4 text-templa-brown">¿Cuál es el motivo de tu reserva?</h3>
            <form [formGroup]="eventoForm" class="evento-form">
              <div class="form-group">
                <div class="evento-options">
                  <div *ngFor="let evento of eventosReserva" 
                       class="evento-option"
                       [class.selected]="eventoForm.get('evento')?.value === evento"
                       (click)="eventoForm.patchValue({evento: evento})">
                    <div class="evento-card">
                      <div class="evento-icon">
                        <i [class]="getEventoIcon(evento)"></i>
                      </div>
                      <div class="evento-name">{{ getEventoDisplayName(evento) }}</div>
                    </div>
                  </div>
                </div>
                <div *ngIf="eventoForm.get('evento')?.invalid && eventoForm.get('evento')?.touched" 
                     class="error-message">
                  Debe seleccionar un tipo de evento
                </div>
              </div>
            </form>
          </div>

          <!-- Paso 4: Horario -->
          <div *ngIf="currentStep === 4" class="step-content">
            <h3 class="text-center mb-4 text-templa-brown">Seleccioná tu horario</h3>
            <form [formGroup]="horarioForm" class="horario-form">
              <div class="form-group">
                <div class="evento-horario-info" *ngIf="eventoForm.get('evento')?.value">
                  <small class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    <span *ngIf="eventoForm.get('evento')?.value === 'ALMUERZO'">
                      Horarios de almuerzo disponibles: 12:00 - 14:30
                    </span>
                    <span *ngIf="eventoForm.get('evento')?.value === 'CENA'">
                      Horarios de cena disponibles: 20:00 - 22:00
                    </span>
                    <span *ngIf="eventoForm.get('evento')?.value !== 'ALMUERZO' && eventoForm.get('evento')?.value !== 'CENA'">
                      Todos los horarios disponibles para este evento
                    </span>
                  </small>
                </div>
                <div class="horario-options">
                  <div *ngFor="let horario of horariosDisponibles" 
                       class="horario-option"
                       [class.selected]="horarioForm.get('horario')?.value === horario"
                       (click)="horarioForm.patchValue({horario: horario})">
                    <div class="horario-card">
                      {{ horario }}
                    </div>
                  </div>
                </div>
                <div *ngIf="horarioForm.get('horario')?.invalid && horarioForm.get('horario')?.touched" 
                     class="error-message">
                  Debe seleccionar un horario
                </div>
              </div>
            </form>
          </div>

          <!-- Paso 5: Datos del Cliente -->
          <div *ngIf="currentStep === 5" class="step-content">
            <h3 class="text-center mb-4 text-templa-brown">Completá tus datos</h3>
            <div class="client-form-container centered-form">
              <form [formGroup]="personaMesaForm" class="persona-form">
                <!-- Primera fila: Nombre y Apellido -->
                <div class="form-row">
                  <div class="form-group">
                    <input type="text" 
                           id="nombre" 
                           name="nombre" 
                           formControlName="nombre" 
                           class="form-control custom-input" 
                           placeholder="Nombre">
                    <div *ngIf="personaMesaForm.get('nombre')?.invalid && personaMesaForm.get('nombre')?.touched" 
                         class="error-message">
                      El nombre es requerido
                    </div>
                  </div>

                  <div class="form-group">
                    <input type="text" 
                           id="apellido" 
                           name="apellido" 
                           formControlName="apellido" 
                           class="form-control custom-input" 
                           placeholder="Apellido">
                    <div *ngIf="personaMesaForm.get('apellido')?.invalid && personaMesaForm.get('apellido')?.touched" 
                         class="error-message">
                      El apellido es requerido
                    </div>
                  </div>
                </div>

                <!-- Segunda fila: DNI -->
                <div class="form-row">
                  <div class="form-group full-width">
                    <input type="text" 
                           id="dni" 
                           name="dni" 
                           formControlName="dni" 
                           class="form-control custom-input" 
                           placeholder="DNI" 
                           maxlength="8">
                    <div *ngIf="personaMesaForm.get('dni')?.invalid && personaMesaForm.get('dni')?.touched" 
                         class="error-message">
                      <span *ngIf="personaMesaForm.get('dni')?.errors?.['required']">El DNI es requerido</span>
                      <span *ngIf="personaMesaForm.get('dni')?.errors?.['pattern']">El DNI debe tener 8 dígitos</span>
                    </div>
                  </div>
                </div>

                <!-- Tercera fila: Email y Teléfono -->
                <div class="form-row">
                  <div class="form-group">
                    <input type="email" 
                           id="email" 
                           name="email" 
                           formControlName="email" 
                           class="form-control custom-input" 
                           placeholder="ejemplo@templa.com *" 
                           required>
                    <div *ngIf="personaMesaForm.get('email')?.invalid && personaMesaForm.get('email')?.touched" 
                         class="error-message">
                      <span *ngIf="personaMesaForm.get('email')?.errors?.['required']">El email es obligatorio para enviar la confirmación</span>
                      <span *ngIf="personaMesaForm.get('email')?.errors?.['email']">Ingrese un email válido</span>
                    </div>
                  </div>

                  <div class="form-group">
                    <input type="tel" 
                           id="telefono" 
                           name="telefono" 
                           formControlName="telefono" 
                           class="form-control custom-input" 
                           placeholder="351811074">
                    <div *ngIf="personaMesaForm.get('telefono')?.invalid && personaMesaForm.get('telefono')?.touched" 
                         class="error-message">
                      El teléfono es requerido
                    </div>
                  </div>
                </div>

                <!-- Separador -->
                <div class="section-divider"></div>
              </form>
            </div>

            <!-- Resumen de la reserva - Solo mostrar cuando los datos estén completos -->
            <div class="reserva-resumen-container" *ngIf="personaMesaForm.valid && personaMesaForm.get('nombre')?.value && personaMesaForm.get('apellido')?.value && personaMesaForm.get('dni')?.value && personaMesaForm.get('telefono')?.value">
              <div class="reserva-resumen-card">
                <div class="resumen-header">
                  <h4><i class="fas fa-clipboard-check"></i> Resumen de tu reserva</h4>
                  <p class="resumen-subtitle">Confirma que todos los datos sean correctos</p>
                </div>
                
                <div class="resumen-content">
                  <div class="resumen-section">
                    <h5><i class="fas fa-user"></i> Datos del Cliente</h5>
                    <div class="resumen-row">
                      <span class="resumen-label">Nombre completo:</span>
                      <span class="resumen-value">{{ personaMesaForm.get('nombre')?.value }} {{ personaMesaForm.get('apellido')?.value }}</span>
                    </div>
                    <div class="resumen-row">
                      <span class="resumen-label">DNI:</span>
                      <span class="resumen-value">{{ personaMesaForm.get('dni')?.value }}</span>
                    </div>
                    <div class="resumen-row">
                      <span class="resumen-label">Teléfono:</span>
                      <span class="resumen-value">{{ personaMesaForm.get('telefono')?.value }}</span>
                    </div>
                    <div class="resumen-row" *ngIf="personaMesaForm.get('email')?.value">
                      <span class="resumen-label">Email:</span>
                      <span class="resumen-value">{{ personaMesaForm.get('email')?.value }}</span>
                    </div>
                    
                    <!-- Mensaje informativo sobre email de confirmación -->
                    <div class="email-confirmation-info" *ngIf="personaMesaForm.get('email')?.value" 
                         style="background: #e8f5e9; padding: 12px; border-radius: 8px; margin-top: 10px;">
                      <p style="color: #27ae60; margin: 0; font-size: 0.9em;">
                        <i class="fas fa-envelope"></i> 
                        Se enviará un email de confirmación a esta dirección
                      </p>
                    </div>
                  </div>
                  
                  <div class="resumen-divider"></div>
                  
                  <div class="resumen-section">
                    <h5><i class="fas fa-calendar-alt"></i> Detalles de la Reserva</h5>
                    <div class="resumen-row">
                      <span class="resumen-label">Fecha:</span>
                      <span class="resumen-value">{{ reservaData.fechaReserva | date:'dd/MM/yyyy' }}</span>
                    </div>
                    <div class="resumen-row">
                      <span class="resumen-label">Horario:</span>
                      <span class="resumen-value">{{ reservaData.horario }}</span>
                    </div>
                    <div class="resumen-row">
                      <span class="resumen-label">Comensales:</span>
                      <span class="resumen-value">{{ reservaData.cantidadComensales }} personas</span>
                    </div>
                    <div class="resumen-row">
                      <span class="resumen-label">Evento:</span>
                      <span class="resumen-value">{{ getEventoDisplayName(reservaData.evento) }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Resumen y Confirmación (paso final removido, ahora en paso 5) -->
          <div *ngIf="currentStep === 6" class="step-content">
            <h3 class="text-center mb-4 text-templa-brown">Confirmá tu reserva</h3>
            <div class="reserva-resumen-container">
              <div class="reserva-resumen-card">
                <div class="resumen-header">
                  <h4><i class="bi bi-clipboard-check"></i> Resumen de tu reserva</h4>
                  <p class="resumen-subtitle">Confirma que todos los datos sean correctos</p>
                </div>
                
                <div class="resumen-content">
                  <div class="resumen-section">
                    <h5><i class="bi bi-calendar-event"></i> Datos de la reserva</h5>
                    <div class="resumen-row">
                      <span class="resumen-label">Evento:</span>
                      <span class="resumen-value">{{getEventoDisplayName(reservaData.evento)}}</span>
                    </div>
                    <div class="resumen-row">
                      <span class="resumen-label">Fecha:</span>
                      <span class="resumen-value">{{fechaForm.get('fechaReserva')?.value | date:'dd/MM/yyyy'}}</span>
                    </div>
                    <div class="resumen-row">
                      <span class="resumen-label">Horario:</span>
                      <span class="resumen-value">{{reservaData.horario}}</span>
                    </div>
                    <div class="resumen-row">
                      <span class="resumen-label">Comensales:</span>
                      <span class="resumen-value">{{comensalesForm.get('cantidadComensales')?.value}} persona(s)</span>
                    </div>
                  </div>
                  
                  <div class="resumen-divider"></div>
                  
                  <div class="resumen-section">
                    <h5><i class="bi bi-person-circle"></i> Datos personales</h5>
                    <div class="resumen-row">
                      <span class="resumen-label">Nombre completo:</span>
                      <span class="resumen-value">{{personaMesaForm.get('nombre')?.value}} {{personaMesaForm.get('apellido')?.value}}</span>
                    </div>
                    <div class="resumen-row">
                      <span class="resumen-label">DNI:</span>
                      <span class="resumen-value">{{personaMesaForm.get('dni')?.value}}</span>
                    </div>
                    <div class="resumen-row">
                      <span class="resumen-label">Teléfono:</span>
                      <span class="resumen-value">{{personaMesaForm.get('telefono')?.value}}</span>
                    </div>
                    <div class="resumen-row">
                      <span class="resumen-label">Email:</span>
                      <span class="resumen-value">{{personaMesaForm.get('email')?.value}}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Botones de navegación -->
          <div class="navigation-buttons mt-4">
            <button type="button" 
                    class="btn btn-secondary" 
                    *ngIf="currentStep > 1" 
                    (click)="prevStep()">
              <i class="fas fa-arrow-left"></i> Anterior
            </button>
            
            <button type="button" 
                    class="btn btn-secondary" 
                    *ngIf="currentStep === 1" 
                    (click)="volverAlInicio()">
              <i class="fas fa-arrow-left"></i> Volver al inicio
            </button>
            
            <button type="button" 
                    class="btn btn-primary" 
                    *ngIf="currentStep < 5" 
                    [disabled]="!validateCurrentStep()"
                    (click)="nextStep()">
              Siguiente <i class="fas fa-arrow-right"></i>
            </button>
            
            <button type="button" 
                    class="btn btn-success" 
                    *ngIf="currentStep === 5" 
                    [disabled]="!validateCurrentStep()"
                    (click)="confirmarReserva()">
              <i class="fas fa-check"></i> Confirmar Reserva
            </button>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>
